<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>My Personal App</title>
  <style>
    :root { --bg: #0b1220; --card: #111827; --ink: #e5e7eb; --muted:#9ca3af; --accent:#0ea5e9; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; }
    @media (prefers-color-scheme: light) { :root { --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569; } }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--ink); }
    header { position: sticky; top:0; z-index: 10; backdrop-filter: blur(8px); background: color-mix(in oklab, var(--bg) 75%, transparent); border-bottom: 1px solid color-mix(in oklab, var(--ink) 12%, transparent); }
    .wrap { max-width: 860px; margin: 0 auto; padding: 16px; }
    .title { display: flex; align-items: center; gap: 12px; }
    .logo { width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), #22d3ee); display:grid; place-items:center; color: white; font-weight: 900; }
    .btn { appearance: none; border: 1px solid color-mix(in oklab, var(--ink) 15%, transparent); background: color-mix(in oklab, var(--card) 92%, var(--accent) 8%); color: var(--ink); padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: transform .06s ease, box-shadow .2s ease; box-shadow: 0 6px 20px -12px color-mix(in oklab, black 40%, var(--accent) 60%); }
    .btn:active { transform: translateY(1px); }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .card { grid-column: span 12; background: var(--card); border: 1px solid color-mix(in oklab, var(--ink) 10%, transparent); border-radius: 16px; padding: 16px; }
    @media (min-width: 720px) {
      .card.half { grid-column: span 6; }
      .card.third { grid-column: span 4; }
    }
    .muted { color: var(--muted); font-size: 14px; }
    input[type="text"], textarea { width: 100%; padding: 12px 14px; background: color-mix(in oklab, var(--card) 85%, #000 15%); color: var(--ink); border: 1px solid color-mix(in oklab, var(--ink) 12%, transparent); border-radius: 12px; outline: none; }
    textarea { min-height: 160px; resize: vertical; }
    .row { display: flex; gap: 8px; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { display: grid; grid-template-columns: 28px 1fr auto; align-items: center; gap: 10px; padding: 10px; border: 1px solid color-mix(in oklab, var(--ink) 10%, transparent); border-radius: 12px; margin-bottom: 8px; background: color-mix(in oklab, var(--card) 96%, #000 4%); }
    li.done { opacity: .7; text-decoration: line-through; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid color-mix(in oklab, var(--ink) 15%, transparent); }
    footer { text-align: center; opacity: .7; font-size: 12px; padding: 24px 0 64px; }
    .install-tip { display:none; margin-left:auto; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <div class="logo" aria-hidden>MT</div>
      <div style="flex:1">
        <div style="font-weight: 800; font-size: 18px">My Personal App</div>
        <div class="muted">Offline notes + tasks. Installable.</div>
      </div>
      <button id="installBtn" class="btn install-tip" title="Install this app">Install</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card half" aria-labelledby="todoTitle">
        <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px">
          <h2 id="todoTitle" style="margin:0">Tasks</h2>
          <span id="taskStats" class="pill muted">0 open</span>
        </div>
        <div class="row" style="margin-bottom: 10px">
          <input id="taskInput" type="text" placeholder="Add a task and press Enter" />
          <button id="addTask" class="btn" aria-label="Add task">Add</button>
        </div>
        <ul id="taskList"></ul>
        <div class="row" style="justify-content: space-between; margin-top:10px">
          <button id="clearDone" class="btn" title="Remove completed tasks">Clear done</button>
          <button id="exportTasks" class="btn" title="Backup tasks to a file">Export</button>
        </div>
      </section>

      <section class="card half" aria-labelledby="notesTitle">
        <div class="row" style="justify-content: space-between; align-items:center; margin-bottom: 8px">
          <h2 id="notesTitle" style="margin:0">Notes</h2>
          <span class="pill muted">Autosaves offline</span>
        </div>
        <textarea id="notes" placeholder="Write anythingâ€¦"></textarea>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="exportNotes" class="btn">Export Notes</button>
          <button id="wipeAll" class="btn" title="Delete everything (tasks + notes)">Factory Reset</button>
        </div>
      </section>

      <section class="card third" aria-labelledby="aboutTitle">
        <h3 id="aboutTitle" style="margin-top:0">About</h3>
        <p class="muted">This is a <strong>single-file PWA</strong> you can host anywhere and install on your phone or desktop. Everything is stored locally on your device.</p>
        <ul>
          <li>âœ… Works offline</li>
          <li>ðŸ“² Installable as an app</li>
          <li>ðŸ›Ÿ Local backups via export</li>
          <li>ðŸ”’ No accounts or servers</li>
        </ul>
      </section>

      <section class="card third" aria-labelledby="settingsTitle">
        <h3 id="settingsTitle" style="margin-top:0">Settings</h3>
        <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:10px">
          <label for="name">App Name</label>
          <input id="name" type="text" style="max-width: 60%" placeholder="My Personal App"/>
        </div>
        <div class="row" style="align-items:center; justify-content:space-between; margin-bottom:10px">
          <label for="initials">Icon Text</label>
          <input id="initials" type="text" style="max-width: 40%" placeholder="MT" maxlength="3"/>
        </div>
        <button id="applyBrand" class="btn">Apply Branding</button>
      </section>

      <section class="card third" aria-labelledby="installTitle">
        <h3 id="installTitle" style="margin-top:0">Install tips</h3>
        <ol>
          <li>Open this page over HTTPS (e.g., GitHub Pages).</li>
          <li>Tap <em>Install</em> (or use browser menu â†’ <em>Add to Home screen</em>).</li>
          <li>Use it offline; your data stays on your device.</li>
        </ol>
        <p class="muted">If the Install button is hidden, your browser will show the install option in its menu once requirements are met.</p>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap">v1.0 Â· Made for you</div>
  </footer>

  <script>
    // ---------------------------
    // Tiny helper & storage layer
    // ---------------------------
    const $ = sel => document.querySelector(sel);
    const store = {
      get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      del: k => localStorage.removeItem(k)
    };

    // ---------------------------
    // App branding (name + icon)
    // ---------------------------
    function makeIconSVG(text="MT", bg1="#0ea5e9", bg2="#22d3ee") {
      const safe = (text || "").slice(0,3).toUpperCase();
      return `<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="${bg1}"/><stop offset="1" stop-color="${bg2}"/></linearGradient></defs><rect width="512" height="512" rx="96" ry="96" fill="url(#g)"/><text x="50%" y="54%" text-anchor="middle" dominant-baseline="middle" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" font-size="220" font-weight="900" fill="#ffffff">${safe}</text></svg>`;
    }

    function svgDataURL(svg) {
      const enc = encodeURIComponent(svg).replace(/'/g, "%27").replace(/\(/g, "%28").replace(/\)/g, "%29");
      return `data:image/svg+xml;charset=utf-8,${enc}`;
    }

    function makeManifest(name="My Personal App", iconText="MT") {
      const iconSrc = svgDataURL(makeIconSVG(iconText));
      return {
        name, short_name: name, start_url: ".", display: "standalone", background_color: "#0b1220", theme_color: "#0ea5e9",
        icons: [
          { src: iconSrc, sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
          { src: iconSrc, sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
        ]
      };
    }

    function applyBranding() {
      const appName = $('#name').value.trim() || 'My Personal App';
      const initials = $('#initials').value.trim() || 'MT';
      document.title = appName;
      $('.logo').textContent = initials.toUpperCase().slice(0,3);
      $('.logo').setAttribute('aria-label', initials);
      store.set('branding', { appName, initials });
      // Update manifest link dynamically
      const manifestObj = makeManifest(appName, initials);
      const blob = new Blob([JSON.stringify(manifestObj)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      let link = document.querySelector('link[rel="manifest"]');
      if (!link) { link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
      link.href = url;
    }

    // Load saved branding on start
    (function initBranding() {
      const b = store.get('branding', { appName: 'My Personal App', initials: 'MT' });
      $('#name').value = b.appName; $('#initials').value = b.initials; applyBranding();
    })();

    $('#applyBrand').addEventListener('click', applyBranding);

    // ---------------------------
    // Tasks
    // ---------------------------
    function renderTasks() {
      const list = store.get('tasks', []);
      const ul = $('#taskList'); ul.innerHTML = '';
      let open = 0;
      list.forEach((t, idx) => {
        if (!t.done) open++;
        const li = document.createElement('li');
        li.className = t.done ? 'done' : '';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=t.done; cb.addEventListener('change',()=>{ list[idx].done = cb.checked; store.set('tasks', list); renderTasks(); });
        const text = document.createElement('div'); text.textContent = t.text;
        const del = document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.addEventListener('click',()=>{ list.splice(idx,1); store.set('tasks', list); renderTasks(); });
        li.appendChild(cb); li.appendChild(text); li.appendChild(del); ul.appendChild(li);
      });
      $('#taskStats').textContent = `${open} open`;
    }

    function addTaskFromInput() {
      const val = $('#taskInput').value.trim(); if (!val) return;
      const list = store.get('tasks', []); list.unshift({ text: val, done: false }); store.set('tasks', list);
      $('#taskInput').value=''; renderTasks();
    }

    $('#addTask').addEventListener('click', addTaskFromInput);
    $('#taskInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') addTaskFromInput(); });
    $('#clearDone').addEventListener('click', ()=>{ const list = store.get('tasks', []).filter(t=>!t.done); store.set('tasks', list); renderTasks(); });

    $('#exportTasks').addEventListener('click', ()=>{
      const data = new Blob([JSON.stringify(store.get('tasks', []), null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(data); a.download = 'tasks-backup.json'; a.click();
    });

    renderTasks();

    // ---------------------------
    // Notes
    // ---------------------------
    const notes = $('#notes');
    notes.value = store.get('notes', '');
    notes.addEventListener('input', ()=> store.set('notes', notes.value));
    $('#exportNotes').addEventListener('click', ()=>{
      const data = new Blob([notes.value], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(data); a.download = 'notes.txt'; a.click();
    });

    // Dangerous: wipe all
    $('#wipeAll').addEventListener('click', ()=>{
      if (confirm('This deletes all tasks and notes on this device. Continue?')) {
        store.del('tasks'); store.del('notes'); store.del('branding'); location.reload();
      }
    });

    // ---------------------------
    // PWA: dynamic manifest + SW
    // ---------------------------
    // Create a very small service worker on the fly so this single-file app can be a PWA
    function registerSW() {
      const swCode = `
        const CACHE = 'single-file-pwa-v1';
        self.addEventListener('install', (e) => {
          e.waitUntil((async () => {
            const cache = await caches.open(CACHE);
            try {
              const resp = await fetch(self.registration.scope, {cache:'reload'});
              await cache.put(self.registration.scope, resp.clone());
            } catch (err) {
              // ignore if scope fetch fails (e.g., sandbox preview)
            }
            self.skipWaiting();
          })());
        });
        self.addEventListener('activate', (e)=> e.waitUntil(self.clients.claim()));
        self.addEventListener('fetch', (e) => {
          const url = new URL(e.request.url);
          if (url.origin === location.origin) {
            // Cache-first for same-origin; fall back to network
            e.respondWith((async () => {
              const cache = await caches.open(CACHE);
              const cached = await cache.match(e.request);
              if (cached) return cached;
              try {
                const resp = await fetch(e.request);
                if (e.request.method === 'GET' && resp.ok) cache.put(e.request, resp.clone());
                return resp;
              } catch (err) {
                // Fallback to index for navigations
                if (e.request.mode === 'navigate') {
                  const home = await cache.match(self.registration.scope);
                  if (home) return home; 
                }
                throw err;
              }
            })());
          }
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const swURL = URL.createObjectURL(blob);
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(swURL).catch(()=>{});
      }
    }
    registerSW();

    // Install prompt handler
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBtn').style.display = 'inline-block';
    });
    $('#installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return alert('Install option will appear once requirements are met. Try the browser menu.');
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null;
      if (outcome === 'accepted') $('#installBtn').classList.add('hidden');
    });

    // Hide install button if already installed
    window.addEventListener('appinstalled', ()=> $('#installBtn').classList.add('hidden'));

    // If running in sandbox/file context, some PWA features wonâ€™t work â€” thatâ€™s okay.
  </script>
</body>
</html>
